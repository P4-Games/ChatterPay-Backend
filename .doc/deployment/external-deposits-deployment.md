# External Deposits with Alchemy Webhook

## Purpose

Instructions to configure **Alchemy Webhooks** for external deposits in ChatterPay.
You **must configure the environment variables** — the detailed list and descriptions are in **`example_env`** at the root of the repository.


## 1️⃣ Alchemy Dashboard Configuration

1. In the **Alchemy dashboard**, open your app that matches the target network.
2. Go to **Webhooks** → **Create Webhook** → select **Address Activity**.
3. Add the wallet addresses you want to monitor (`wallets_to_monitor`).
4. Set the **Webhook URL** depending on your environment:

   * **Local:** use an exposed dev URL (see the ngrok explanation below).
   * **Staging:** your staging backend endpoint.
   * **Production:** your production backend endpoint.
5. Save the webhook and **copy the Auth Token and Signing Key immediately** — they appear only once.



## 2️⃣ What the hell is ngrok

**ngrok** is a small CLI tool that temporarily exposes your local server to the internet.
Basically, it creates a secure public HTTPS tunnel that points to your local port — useful when you’re testing webhooks or APIs that require a reachable URL.

Example:

```bash
# Runs your backend locally
bun run dev

# Exposes port 3000 publicly
ngrok http 3000
```

ngrok gives you a temporary HTTPS URL like:

```
https://2f8a-201-123-45-67.ngrok.io
```

That’s the URL you paste in the Alchemy dashboard as the webhook endpoint for local testing:

```
https://2f8a-201-123-45-67.ngrok.io/webhooks/alchemy/deposits
```

When Alchemy sends an event, it hits that public URL, and ngrok forwards it directly to your local backend.

## 3️⃣ Webhook Header API Key

After creating the webhook, trigger a test event from the Alchemy dashboard.
Inspect the headers of the incoming request — one of them includes the `x-api-key`.
Use that value as `ALCHEMY_WEBHOOK_HEADER_API_KEY` (see `example_env`).

This header is **not derived** from `ALCHEMY_AUTH_TOKEN` or `ALCHEMY_SIGNING_KEY`.
It is a **random value generated by Alchemy when the webhook is created**, and it may change if the webhook is deleted or recreated.
There is **no API endpoint** to retrieve it — the only way to obtain it is by reading a real webhook request.

Validating this key in your backend is **optional** and mainly useful for paid plans.
For the free plan, you can safely skip this validation and rely solely on HMAC verification (`x-alchemy-signature`).


## 4️⃣ Security Validation (Backend)

Your webhook handler must:

* Validate the `x-alchemy-signature` header with the signing key.
* Validate the `x-api-key` header against your stored key.
* Reject any unsigned or mismatched payloads.

## 5️⃣ Reference

All environment variables for this setup are defined and documented in **`example_env`** (root of the repository).
Do **not** redefine them here.
