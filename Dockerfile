FROM node:20.19.0-bullseye AS base

COPY package.json bun.lockb tsconfig.json ./
RUN curl -fsSL https://bun.sh/install | bash -s "bun-v1.1.21" && \
    echo 'export BUN_INSTALL="$HOME/.bun"' >> ~/.bashrc && \
    echo 'export PATH="$BUN_INSTALL/bin:$PATH"' >> ~/.bashrc && \
    echo 'export PATH="$BUN_INSTALL/bin:$PATH"' >> ~/.profile && \
    echo 'export PATH="$BUN_INSTALL/bin:$PATH"' >> ~/.bash_profile

# Ensure Bun is available in PATH
ENV BUN_INSTALL="/root/.bun"
ENV PATH="${BUN_INSTALL}/bin:${PATH}"

RUN node -v && bun -v
WORKDIR /app 

# Copy environment variables as build arguments
ARG BUN_ENV
ARG INFURA_API_KEY
ARG MONGO_URI
ARG SEED_INTERNAL_SALT
ARG SIGNING_KEY
ARG PINATA_JWT
ARG ICP_CANISTER_ID
ARG ICP_MNEMONIC
ARG BOT_API_URL
ARG BOT_DATA_TOKEN
ARG NFT_UPLOAD_IMAGE_ICP
ARG NFT_UPLOAD_IMAGE_IPFS
ARG GCP_BUCKET_BASE_URL
ARG CHATIZALO_TOKEN
ARG FRONTEND_TOKEN
ARG PUSH_ENABLED
ARG PUSH_NETWORK
ARG PUSH_ENVIRONMENT
ARG PUSH_CHANNEL_ADDRESS
ARG PUSH_CHANNEL_PRIVATE_KEY
ARG MINOR_LOG_LEVEL
ARG MANTECA_BASE_URL
ARG MANTECA_API_KEY
ARG THE_GRAPH_EXTERNAL_DEPOSITS_URL
ARG THE_GRAPH_API_KEY
ARG GCP_CLOUD_TRACE_ENABLED
ARG CORS_ORIGINS
ARG BLACKLIST_IPS
ARG DEFAULT_CHAIN_ID
ARG ABIS_VERSION
ARG CORS_ORIGINS_CHECK_POSTMAN
ARG SWAP_SLIPPAGE_CONFIG_STABLE
ARG SWAP_SLIPPAGE_CONFIG_DEFAULT
ARG SWAP_SLIPPAGE_CONFIG_EXTRA
ARG SWAP_ZERO_FEE_MODE
ARG SWAP_EXECUTE_SIMPLE
ARG SWAP_USE_QUOTER
ARG ABIS_READ_FROM
ARG CHATIZALO_PHONE_NUMBER
ARG QUEUE_BUNDLER_INTERVAL
ARG QUEUE_GAS_INTERVAL
ARG QUEUE_CREATE_PROXY_INTERVAL
ARG ISSUER_TOKENS_ENABLED
ARG MAX_REQUESTS_PER_MINUTE
ARG CHATTERPOINTS_WORDS_SEED
ARG CHATTERPOINTS_WORDS_READ_FROM
ARG CDS1
ARG CDS2
ARG CDS3
ARG CDO1
ARG CDO2
ARG CDO3
ARG CDO4
ARG CDP1
ARG CDP2
ARG TELEGRAM_BOT_API_KEY
ARG EXTERNAL_DEPOSITS_PROVIDER
ARG SECURITY_PIN_LENGTH
ARG SECURITY_PIN_MAX_FAILED_ATTEMPTS
ARG SECURITY_PIN_BLOCK_MINUTES
ARG SECURITY_PIN_ENABLED
ARG SECURITY_PIN_HMAC_KEY
ARG ALCHEMY_VAR_WALLETS_ID
ARG ALCHEMY_VAR_WALLETS_TOPIC_ID
ARG ALCHEMY_VAR_TOKENS_ID
ARG ALCHEMY_AUTH_TOKEN
ARG ALCHEMY_SIGNING_KEY
ARG ALCHEMY_WEBHOOK_HEADER_API_KEY
ARG ALCHEMY_VALIDATE_WEBHOOK_HEADER_API_KEY


# Set environment variables
ENV BUN_ENV $BUN_ENV
ENV INFURA_API_KEY $INFURA_API_KEY
ENV MONGO_URI $MONGO_URI
ENV SEED_INTERNAL_SALT $SEED_INTERNAL_SALT
ENV SIGNING_KEY $SIGNING_KEY
ENV PINATA_JWT $PINATA_JWT
ENV ICP_CANISTER_ID $ICP_CANISTER_ID
ENV ICP_MNEMONIC $ICP_MNEMONIC
ENV BOT_API_URL $BOT_API_URL
ENV BOT_DATA_TOKEN $BOT_DATA_TOKEN
ENV NFT_UPLOAD_IMAGE_ICP $NFT_UPLOAD_IMAGE_ICP
ENV NFT_UPLOAD_IMAGE_IPFS $NFT_UPLOAD_IMAGE_IPFS
ENV GCP_BUCKET_BASE_URL $GCP_BUCKET_BASE_URL
ENV CHATIZALO_TOKEN $CHATIZALO_TOKEN
ENV FRONTEND_TOKEN $FRONTEND_TOKEN
ENV PUSH_ENABLED $PUSH_ENABLED
ENV PUSH_NETWORK $PUSH_NETWORK
ENV PUSH_ENVIRONMENT $PUSH_ENVIRONMENT
ENV PUSH_CHANNEL_ADDRESS $PUSH_CHANNEL_ADDRESS
ENV PUSH_CHANNEL_PRIVATE_KEY $PUSH_CHANNEL_PRIVATE_KEY
ENV MINOR_LOG_LEVEL $MINOR_LOG_LEVEL
ENV MANTECA_BASE_URL $MANTECA_BASE_URL
ENV MANTECA_API_KEY $MANTECA_API_KEY
ENV THE_GRAPH_EXTERNAL_DEPOSITS_URL $THE_GRAPH_EXTERNAL_DEPOSITS_URL
ENV THE_GRAPH_API_KEY $THE_GRAPH_API_KEY
ENV GCP_CLOUD_TRACE_ENABLED $GCP_CLOUD_TRACE_ENABLED
ENV CORS_ORIGINS $CORS_ORIGINS
ENV BLACKLIST_IPS $BLACKLIST_IPS
ENV DEFAULT_CHAIN_ID $DEFAULT_CHAIN_ID
ENV ABIS_VERSION $ABIS_VERSION
ENV CORS_ORIGINS_CHECK_POSTMAN $CORS_ORIGINS_CHECK_POSTMAN
ENV SWAP_SLIPPAGE_CONFIG_STABLE $SWAP_SLIPPAGE_CONFIG_STABLE
ENV SWAP_SLIPPAGE_CONFIG_DEFAULT $SWAP_SLIPPAGE_CONFIG_DEFAULT
ENV SWAP_SLIPPAGE_CONFIG_EXTRA $SWAP_SLIPPAGE_CONFIG_EXTRA
ENV SWAP_ZERO_FEE_MODE $SWAP_ZERO_FEE_MODE
ENV SWAP_EXECUTE_SIMPLE $SWAP_EXECUTE_SIMPLE
ENV SWAP_USE_QUOTER $SWAP_USE_QUOTER
ENV ABIS_READ_FROM $ABIS_READ_FROM
ENV CHATIZALO_PHONE_NUMBER $CHATIZALO_PHONE_NUMBER
ENV QUEUE_BUNDLER_INTERVAL $QUEUE_BUNDLER_INTERVAL
ENV QUEUE_GAS_INTERVAL $QUEUE_GAS_INTERVAL
ENV QUEUE_CREATE_PROXY_INTERVAL $QUEUE_CREATE_PROXY_INTERVAL
ENV ISSUER_TOKENS_ENABLED $ISSUER_TOKENS_ENABLED
ENV MAX_REQUESTS_PER_MINUTE $MAX_REQUESTS_PER_MINUTE
ENV CHATTERPOINTS_WORDS_SEED $CHATTERPOINTS_WORDS_SEED
ENV CHATTERPOINTS_WORDS_READ_FROM $CHATTERPOINTS_WORDS_READ_FROM
ENV CDS1 $CDS1
ENV CDS2 $CDS2
ENV CDS3 $CDS3
ENV CDO1 $CDO1
ENV CDO2 $CDO2
ENV CDO3 $CDO3
ENV CDO4 $CDO4
ENV CDP1 $CDP1
ENV CDP2 $CDP2
ENV TELEGRAM_BOT_API_KEY $TELEGRAM_BOT_API_KEY
ENV EXTERNAL_DEPOSITS_PROVIDER $EXTERNAL_DEPOSITS_PROVIDER
ENV SECURITY_PIN_LENGTH $SECURITY_PIN_LENGTH
ENV SECURITY_PIN_MAX_FAILED_ATTEMPTS $SECURITY_PIN_MAX_FAILED_ATTEMPTS
ENV SECURITY_PIN_BLOCK_MINUTES $SECURITY_PIN_BLOCK_MINUTES
ENV SECURITY_PIN_ENABLED $SECURITY_PIN_ENABLED
ENV SECURITY_PIN_HMAC_KEY $SECURITY_PIN_HMAC_KEY
ENV ALCHEMY_VAR_WALLETS_ID $ALCHEMY_VAR_WALLETS_ID
ENV ALCHEMY_VAR_WALLETS_TOPIC_ID $ALCHEMY_VAR_WALLETS_TOPIC_ID
ENV ALCHEMY_VAR_TOKENS_ID $ALCHEMY_VAR_TOKENS_ID
ENV ALCHEMY_AUTH_TOKEN $ALCHEMY_AUTH_TOKEN
ENV ALCHEMY_SIGNING_KEY $ALCHEMY_SIGNING_KEY
ENV ALCHEMY_WEBHOOK_HEADER_API_KEY $ALCHEMY_WEBHOOK_HEADER_API_KEY
ENV ALCHEMY_VALIDATE_WEBHOOK_HEADER_API_KEY $ALCHEMY_VALIDATE_WEBHOOK_HEADER_API_KEY

# Copy project configuration files
COPY package.json bun.lockb tsconfig.json ./

# Install dependencies securely
RUN bun install --frozen-lockfile

# Copy source code
COPY src ./src

# Expose the port where the application runs
EXPOSE 3000
ENV PORT 3000

# Command to run the application
CMD ["bun", "start"]
